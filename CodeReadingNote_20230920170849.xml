<?xml version="1.0" encoding="UTF-8"?>
<topics>
  <topic>
    <name>cat nodes</name>
    <note />
    <updatedAt>2023-09-20 11:02:23</updatedAt>
    <topicLines>
      <topicLine>
        <line>103</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/rest/action/cat/RestNodesAction.java</url>
        <note>rest layer收到cat nodes请求后，首先获取cluster state</note>
        <relativePath>server/src/main/java/org/elasticsearch/rest/action/cat/RestNodesAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>71</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/client/node/NodeClient.java</url>
        <note>在节点本地执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/client/node/NodeClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>109</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</url>
        <note>执行一个AsyncSingleAction</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>128</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</url>
        <note>开始执行，创建clusterStateObserver</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>137</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</url>
        <note>predicate.test()返回true的情况：
传入的state是在节点加入集群后生成的</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>139</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</url>
        <note>当前节点为master或者request携带参数local=true的情况，在本地执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>178</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</url>
        <note>其他情况发送请求给master</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>169</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</url>
        <note>master节点收到请求后，same线程池(就是当前线程)调度一个的masterOperation</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>99</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/admin/cluster/state/TransportClusterStateAction.java</url>
        <note>构建cluste state并返回</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/admin/cluster/state/TransportClusterStateAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>106</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/rest/action/cat/RestNodesAction.java</url>
        <note>协调节点在回调中执行NodesInfoRequest</note>
        <relativePath>server/src/main/java/org/elasticsearch/rest/action/cat/RestNodesAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>80</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java</url>
        <note>执行asyncAction，asyncAction构造过程中将节点内存集群状态的nodes赋值给request</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>186</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java</url>
        <note>遍历所有节点发送NodeInfoRequest</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>72</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/admin/cluster/node/info/TransportNodesInfoAction.java</url>
        <note>节点收到请求，获取node info</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/admin/cluster/node/info/TransportNodesInfoAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>92</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/node/NodeService.java</url>
        <note>直接从内存获取结果</note>
        <relativePath>server/src/main/java/org/elasticsearch/node/NodeService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>123</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/rest/action/cat/RestNodesAction.java</url>
        <note>向所有节点获取Node states</note>
        <relativePath>server/src/main/java/org/elasticsearch/rest/action/cat/RestNodesAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>112</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/node/NodeService.java</url>
        <note>节点获取node stats，都是调用的getOrRefresh,如果超过刷新间隔则调api取，否则直接返回</note>
        <relativePath>server/src/main/java/org/elasticsearch/node/NodeService.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>transport bulk write流程</name>
    <note>协调节点action： indices:data/write/bulk
数据节点action：indices:data/write/bulk[s][p]
[p]代表primary [r]代表replica [s]代表security
总结：
协调节点通过transportbulkaction处理，transportreplicationaction转发请求到数据节点，数据节点通过transportreplicationaction处理，使用transportshardbulkaction执行index
write流程的每一步开始时会检查是否有阻塞write的exception，如果有就等待clusterstate更新获取是否还有excep，直到超时；防止数据丢失之类，如果被阻塞集群写入性能大大降低，日志中心之前掉盘/节点性能下降30%
写入primary时也会等待primary恢复直到超时
数据复制模型：基于语句的复制
数据复制转发模型：同步复制</note>
    <updatedAt>2023-08-23 18:13:41</updatedAt>
    <topicLines>
      <topicLine>
        <line>339</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/modules/transport-netty4/src/main/java/org/elasticsearch/transport/netty4/Netty4Transport.java</url>
        <note>netty transport server , Netty4MessageChannelHandler来处理请求</note>
        <relativePath>modules/transport-netty4/src/main/java/org/elasticsearch/transport/netty4/Netty4Transport.java</relativePath>
      </topicLine>
      <topicLine>
        <line>130</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/transport/InboundHandler.java</url>
        <note>inboundhandler对request进行处理</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/InboundHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>132</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/transport/InboundHandler.java</url>
        <note>从header中获取client request的requestid，当返回response给client时需要用</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/InboundHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>141</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/transport/InboundPipeline.java</url>
        <note>读到request末尾时进行处理</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/InboundPipeline.java</relativePath>
      </topicLine>
      <topicLine>
        <line>175</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/transport/InboundHandler.java</url>
        <note>选择action对应的线程池进行run</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/InboundHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>62</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/transport/RequestHandlerRegistry.java</url>
        <note>创建一个task包含将要执行action的相关信息</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/RequestHandlerRegistry.java</relativePath>
      </topicLine>
      <topicLine>
        <line>143</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/action/support/TransportAction.java</url>
        <note>request校验</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/TransportAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>176</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/action/support/TransportAction.java</url>
        <note>执行action对应的filters</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/TransportAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>175</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>对应的trasportbulkaction执行doExecute</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>182</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>遍历bulk中的每一个request</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>186</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>检查每个request是否有ingest pipeline</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>213</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>自定义的预处理pipeline处理request</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>226</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>创建bulk中涉及的所有索引,异步创建不存在的索引,释放写线程。等待所有索引创建返回时，继续执行写入</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>605</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>构造BulkOperation执行写入</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>407</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>通过obsever获取集群状态，检查集群状态中是否有阻塞写入的exception。如果有则等待下一次集群状态，直到没有exception或超时。
通过向clusterapplierservice add一个timeoutlistener来实现，当集群状态变化时，通过向clusterapplierservice就会调用该listener的onNewClusterState进行重试run</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>433</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>如果doc没有id，为其自动生成id并用时间戳标记</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>432</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>为request配置routing</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>459</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>遍历所有的request建立ShardId -&gt; Operations 映射</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>466</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>根据路由算法计算shardid，</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>491</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>根据shardid将request异步转发给主节点</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>491</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>执行shardbulkaction来进行下一步</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>187</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>运行reroutephase来转发请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>696</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>reroute phase开始</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>739</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>异步等待primary可用直到超时，比如缺失primary shard就是不可用</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>753</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>本地节点也进行转发</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>795</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>远程节点会通过transportservice转发请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>296</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>primary节点处理indices:data/write/bulk[s][p]的方法</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>326</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>开始主节点写入流程
检查请求： 1.当前是否为主分片；2.allocationId是否是预期值；3.PrimaryTerm是否是预期值</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>346</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>检查当前是否有阻塞的操作，有的话，就缓存起来，等后面阻塞的操作完成后再执行。阻塞操作：ReplicationTracker中节点变为relocated状态</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>289</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShardOperationPermits.java</url>
        <note>获取执行当前shard写的信号量</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShardOperationPermits.java</relativePath>
      </topicLine>
      <topicLine>
        <line>365</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>等待写操作不被block</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>371</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>检查主分片是否已经迁移完成，如果迁移完成将请求路由给目标节点。如果该写操作是relocated相关的block opration阻塞的，那么肯定会走这里。所以走这里的情况很少</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>113</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</url>
        <note>判断active的shard数量是否足够，不足则不写入。默认为1.</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</relativePath>
      </topicLine>
      <topicLine>
        <line>155</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java</url>
        <note>开始在primary执行写操作，使用write线程池</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>112</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</url>
        <note>primary执行写入</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>162</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</url>
        <note>遍历bulk中的所有request</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>216</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</url>
        <note>执行bulk操作</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>289</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</url>
        <note>如果需要，更新mapping。等待更新mapping成功后，触发itemDoneListener，再循环一次该bulk流程</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>807</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>执行index操作</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>875</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>ES的写入操作是先写lucene，将数据写入到lucene内存后再写translog。
ES之所以先写lucene后写log主要原因大概是写入Lucene时，Lucene会再对数据进行一些检查，有可能出现写入Lucene失败的情况。
如果先写translog，那么就要处理写入translog成功但是写入Lucene一直失败的问题，所以ES采用了先写Lucene的方式。</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1032</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>判断是否是自动生成的ID，如果是则做优化，不会去查询id是否存在和调用updatedoc（lucene），只会去adddoc</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
      <topicLine>
        <line>934</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>将index根据index plan写入lucene</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
      <topicLine>
        <line>943</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>如果写入lucenne内存成功，将index写入translog</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
      <topicLine>
        <line>959</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>更新local checkpoint</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
      <topicLine>
        <line>147</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</url>
        <note>在写完primary后，回调将触发写并发异步写replica</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1073</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>向副本发送bulk请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>149</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</url>
        <note>发送完replication之后的操作</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</relativePath>
      </topicLine>
      <topicLine>
        <line>241</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java</url>
        <note>调度异步flush(lucene fsync)操作，若配置则将bulk中所有的translog同步落盘，当使用bulk请求时只会产生一次磁盘IO，如果是多次index请求则产生多次IO，这也是bulk较快的主要原因</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>155</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</url>
        <note>可能更新ReplicationTracker包括local和global，checkpoint包含term seq。translog持久化才会更新.primary引用的LocalCheckpointTracker为engine保存,用于持久化和推进localcheckpoint的,replication用于跟踪replica group的所有ckp</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</relativePath>
      </topicLine>
      <topicLine>
        <line>519</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>replica写入数据的入口</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>646</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>allocation id校验。如果写入过程中节点掉线并重连该shard对应数据的allocation id发生变化，也不会影响数据一致性，shard会和primary同步</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>2954</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>检查当前是否有阻塞的操作，有的话，就缓存起来，等后面阻塞的操作完成后再执行。</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>3008</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>使用primary的globalCheckpoint更新replica保存的globalCheckpoint</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>185</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java</url>
        <note>dispatchedShardOperationOnReplica</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>425</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</url>
        <note>performOnReplica</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>430</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</url>
        <note>如果在primary写入失败了，replica不执行写入</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>458</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</url>
        <note>执行单条操作</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>758</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>副本写最终调用的方法和primary相同</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>575</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>写入完成后执行，将结果返回给primary</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>206</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</url>
        <note>replica返回response触发</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</relativePath>
      </topicLine>
      <topicLine>
        <line>209</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</url>
        <note>根据replica返回的持久化localckp和globalcheckpoint，更新主分片上记录的该replica的Checkpoint。以及全局globalcheckpoint</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</relativePath>
      </topicLine>
      <topicLine>
        <line>211</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</url>
        <note>replica均返回时进行finish</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</relativePath>
      </topicLine>
      <topicLine>
        <line>340</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</url>
        <note>统计bulk write的结果信息。将结果返回给协调节点</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java</relativePath>
      </topicLine>
      <topicLine>
        <line>499</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>协调节点将每个shard的request返回的response收集起来</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>502</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</url>
        <note>当所有的shard都返回结果执行,将所有的bulkresponse返回</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>809</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</url>
        <note>协调节点返回结果给客户端</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>971</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/IndexService.java</url>
        <note>用于refresh定时调度。refresh底层在lucene实现</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/IndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1611</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>触发IndexWriter刷新出新的segment，并创建新的ElasticsearchDirectoryReader，使得新数据可读</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>elasticsearch merge</name>
    <note />
    <updatedAt>2023-08-15 15:54:37</updatedAt>
    <topicLines>
      <topicLine>
        <line>2232</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>shard的IndexWriter配置ES自定义的merge scheduler</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
      <topicLine>
        <line>216</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>es merge scheduler初始化</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>force merge</name>
    <note />
    <updatedAt>2023-08-15 15:35:30</updatedAt>
    <topicLines>
      <topicLine>
        <line>77</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/TransportForceMergeAction.java</url>
        <note>transport force merge入口</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/TransportForceMergeAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1127</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>使用传参触发engine.merge</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1978</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>触发 indexWriter.forceMerge</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>rest client perform request</name>
    <note />
    <updatedAt>2023-08-14 17:01:21</updatedAt>
    <topicLines>
      <topicLine>
        <line>328</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>异步执行请求入口</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>332</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>获取集群节点列表执行请求</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>408</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>选择节点列表，会尝试筛选和排序</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>424</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>抛出黑名单后节点数不为零的情况：
通过nodeselector进行过滤，并将之前请求过的节点放到节点列表的末尾来实现round robin轮询</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>451</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>过滤完黑名单没有节点的情况：
选择一个剩余拉黑时间最短的节点</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>344</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>选择节点列表中的第一个节点</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>345</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>调用httpasyncclient执行请求</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>347</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>服务端返回响应的情况</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>294</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>如果状态码是成功的或者是忽略的错误，则将解析为response。后面将触发传入的listener</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>302</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>如果状态码是502/503/504，则将节点拉黑返回一个exception对象，后面会重试请求（如果没迭代完节点）</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>309</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>其他状态码抛出异常，后面不会重试</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>366</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>httpasyncclient执行请求失败触发listener.failed情况</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>369</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/client/rest/src/main/java/org/elasticsearch/client/RestClient.java</url>
        <note>节点拉黑触发sniff on failure listener，尝试下一个节点</note>
        <relativePath>client/rest/src/main/java/org/elasticsearch/client/RestClient.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>client write</name>
    <note>transport client bulk write</note>
    <updatedAt>2023-07-17 17:16:56</updatedAt>
    <topicLines>
      <topicLine>
        <line>394</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/client/transport/TransportClient.java</url>
        <note>调用TransportProxyClient执行action</note>
        <relativePath>server/src/main/java/org/elasticsearch/client/transport/TransportClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>54</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/client/transport/TransportProxyClient.java</url>
        <note>获取action对应的proxy</note>
        <relativePath>server/src/main/java/org/elasticsearch/client/transport/TransportProxyClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>234</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/client/transport/TransportClientNodesService.java</url>
        <note>走到这里。callback是proxy.excute</note>
        <relativePath>server/src/main/java/org/elasticsearch/client/transport/TransportClientNodesService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>47</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/TransportActionNodeProxy.java</url>
        <note>proxy执行send request</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/TransportActionNodeProxy.java</relativePath>
      </topicLine>
      <topicLine>
        <line>599</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/TransportService.java</url>
        <note>client wirte3.获取和节点之间的connection，包含长连接</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/TransportService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>289</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/client/transport/TransportClientNodesService.java</url>
        <note>ConnectTransportException将会选择下个节点重试，都重试过了则返回NoNodeAvailableException</note>
        <relativePath>server/src/main/java/org/elasticsearch/client/transport/TransportClientNodesService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>260</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/TcpTransport.java</url>
        <note>client write4.获取action对应的channel</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/TcpTransport.java</relativePath>
      </topicLine>
      <topicLine>
        <line>200</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/Transport.java</url>
        <note>client wriite4.1为了将request和listner对应上，为每个request生成id，并将id和request放到map</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/Transport.java</relativePath>
      </topicLine>
      <topicLine>
        <line>126</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/OutboundHandler.java</url>
        <note>client write5.使用netty channel发送消息</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/OutboundHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>235</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/Transport.java</url>
        <note>client wirte6.从response的header中获取的id找到对应request的listener进行回调</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/Transport.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>节点间的连接</name>
    <note />
    <updatedAt>2023-06-27 11:36:29</updatedAt>
    <topicLines>
      <topicLine>
        <line>103</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/ClusterConnectionManager.java</url>
        <note>connect to node</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/ClusterConnectionManager.java</relativePath>
      </topicLine>
      <topicLine>
        <line>138</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/ClusterConnectionManager.java</url>
        <note>使用profile作为配置和节点建立连接</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/ClusterConnectionManager.java</relativePath>
      </topicLine>
      <topicLine>
        <line>253</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/ClusterConnectionManager.java</url>
        <note>调用transport层建立连接</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/ClusterConnectionManager.java</relativePath>
      </topicLine>
      <topicLine>
        <line>289</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/TcpTransport.java</url>
        <note>初始化和节点的connection</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/TcpTransport.java</relativePath>
      </topicLine>
      <topicLine>
        <line>295</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/TcpTransport.java</url>
        <note>创建profile配置个数的连接</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/TcpTransport.java</relativePath>
      </topicLine>
      <topicLine>
        <line>273</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/modules/transport-netty4/src/main/java/org/elasticsearch/transport/netty4/Netty4Transport.java</url>
        <note>初始化channel，使用浅拷贝的bootstrap</note>
        <relativePath>modules/transport-netty4/src/main/java/org/elasticsearch/transport/netty4/Netty4Transport.java</relativePath>
      </topicLine>
      <topicLine>
        <line>939</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/TcpTransport.java</url>
        <note>每一个连接建立后触发listener的onResponse</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/TcpTransport.java</relativePath>
      </topicLine>
      <topicLine>
        <line>945</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/TcpTransport.java</url>
        <note>实例化NodeChannels.TcpChannel为真正的连接，NodeChannels还包含选择channel的逻辑</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/TcpTransport.java</relativePath>
      </topicLine>
      <topicLine>
        <line>139</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/ClusterConnectionManager.java</url>
        <note>再触发这个传入的listener</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/ClusterConnectionManager.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>search流程</name>
    <note />
    <updatedAt>2023-06-26 18:48:44</updatedAt>
    <topicLines>
      <topicLine>
        <line>96</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/rest/action/search/RestSearchAction.java</url>
        <note>根据请求的path找到处理*action，执行preparerequest</note>
        <relativePath>server/src/main/java/org/elasticsearch/rest/action/search/RestSearchAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>111</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/rest/action/search/RestSearchAction.java</url>
        <note>将RestRequest转换为SearchRequest，将request.source解析成SearchSourceBuilder（query语句的抽象，每个关键字都有对应的类）。详情可看https://www.elastic.co/blog/the-great-query-refactoring-thou-shalt-only-parse-once</note>
        <relativePath>server/src/main/java/org/elasticsearch/rest/action/search/RestSearchAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>115</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/rest/action/search/RestSearchAction.java</url>
        <note>cancelclient作用：当client关闭链接时，会取消查询的task</note>
        <relativePath>server/src/main/java/org/elasticsearch/rest/action/search/RestSearchAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>243</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java</url>
        <note>对query进行rewrite以优化性能，rewrite过程可能需要fetch某些信息。详见https://www.elastic.co/blog/instant-aggregations-rewriting-queries-for-fun-and-profit。</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>210</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java</url>
        <note>获取所有要查询的索引（用索引别名或者查询path配置多个时，会有多个索引）</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>467</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java</url>
        <note>search的阻塞exception，和write流程中的一样，不再赘述</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>481</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java</url>
        <note>构造集群shard列表，其中ShardIterator中的每个ShardRouting组是使用自适应副本选择算法排序过的</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>513</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java</url>
        <note>是否执行CanMatchPreFilterSearchPhase#25658。
该阶段通过先将请求发送给所有分片进行rewrite query，如果可以rewrite为match none，那么后续的query then fetch就无需查询该分片，由于数据节点响应can match的操作非常轻量级就使用same（对应到transport_worker）线程池。
这么做可以避免search线程池的占用导致search reject.
同时还可以获取排序字段的最大值和最小值，然后协调节点优先查询靠前的分片，如果返回结果大于查询size，使得后面的查询能够取消掉</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>173</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</url>
        <note>skip shard是在CanMatchPreFilterSearchPhase进行标记的，这些shard不会执行query then fetch</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>179</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</url>
        <note>如果未开启allowPartialSearchResults，有分片缺失则返回失败</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>201</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</url>
        <note>遍历shard发送查询请求，shardsIts是涉及的所有分片，shardRoutings.nextOrNull()从某个分片的所有副本选择第一个，该shard routing顺序是使用自适应副本算法排序过的</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>226</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</url>
        <note>使用max_concurrent_shard_requests限制协调节点向单个数据节点发出的shard request数量。超出的request会等待其他request完成才执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>77</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java</url>
        <note>基于已返回的query phase result来rewrite request

利用其他分片的查询结果对query phase剪枝的实现如下：
允许根据在其他分片上收集的信息修改之后分片的query request。 它旨在加速基于时间的索引的排序查询。 
对于只对top hits感兴趣的查询，如果先前分片中计算的最小排序值优于分片中的所有值，则此更改将重写分片查询为match none。
对于包含top hits和聚合的查询，此更改会将top hits语句中的size重置为 0，而不是重写为match none。 这意味着我们不需要为这个分片保持搜索上下文打开，因为我们事先知道它不包含任何竞争性命中。

通常来说只有触发了coordinator node query phase request throtting才会用上该功能，因为正常情况下query phase request的发送时并行的</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>126</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java</url>
        <note>rewrite request增加最小的排序值信息。</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>134</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/SearchTransportService.java</url>
        <note>如果总查询分片数为1，则数据节点上query phase完成后会直接进行fetch，此流程叫做query and fetch ，这里将预期返回的结果为QueryFetchSearchResult。</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/SearchTransportService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>137</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/SearchTransportService.java</url>
        <note>使用transportservice向node发送请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/SearchTransportService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>701</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/TransportService.java</url>
        <note>为发到数据节点的request配置parenttask，即协调节点的search task</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/TransportService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>235</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</url>
        <note>收集数据节点的返回结果</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>490</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</url>
        <note>累加成功的shard，如果所有shard都返回则进行下一阶段</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>242</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</url>
        <note>如果查询失败，则尝试查询下一个shard copy(即该分片的primary或replica)，该顺序是自适应选择算法排序的</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>237</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</url>
        <note>如果队列包含被限制的query phase request，则发送下一个</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>313</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/SearchTransportService.java</url>
        <note>indices:data/read/search[phase/query]
query phase开始</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/SearchTransportService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1171</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>有些情况data node需要再次rewrite request</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1164</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>简单来说就是如果未配置refresh interval,当分片一段时间没查询会暂停refresh来提升写入性能，有查询时先refresh一下再执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>373</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>判断是否可以当query为match none时，直接返回空值，不占用查询线程池构建空response</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>395</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>在search线程池中执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>546</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>如果index被配置为search throttled,使用search throttled线程池查询</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>408</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>使用获取的search线程池执行task</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>428</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>开始执行search phrase</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>631</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>构建searchContext，其中封装了查询的相关信息，例如IndexSearcher 、Lucene Query</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>648</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/Engine.java</url>
        <note>构建IndexSearcher用于搜索。后台进行的refresh会使得IndexReader不断实例化，使得searcher能够搜索到最新的数据</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/Engine.java</relativePath>
      </topicLine>
      <topicLine>
        <line>681</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>将ES dsl转换为Lucene Query对象，调用Lucene查询需要Query对象。并将所有查询信息保存到context</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>433</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>关闭context超时，避免context被free</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>434</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>尝试从request cache读取结果，或执行query phase</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>355</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>从request cache中获取查询结果，或者执行query查询，慢查询query日志中的时间就是这个阶段的时间</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>356</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>判断是否可以使用request_cache。以下情况无法使用：
1. scroll search
2. 不是QUERY_THEN_FETCH
3. profile query
4. request未强制使用request cache并且index setting关闭request cache或查询size!=0
5. request强制不使用request cache
6. 使用毫秒级别的now时间戳</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>124</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/IndicesRequestCache.java</url>
        <note>如果request cache中有缓存直接返回，没有则执行query phase</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/IndicesRequestCache.java</relativePath>
      </topicLine>
      <topicLine>
        <line>135</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/IndicesRequestCache.java</url>
        <note>如果是cache中没有的情况（说明是第一次看到reader），将cleanupKey listener注册到reader上，
当ElasticsearchDirectoryReader被close时，会调用cleanupKey. cleanupKey会将Reader对应的缓存清除。
原因：
request cache需要保证NRT语义，当ElasticsearchDirectoryReader被close时意味着有新的数据可见，旧的cache的结果是不满足NRT语义的，需要清除掉。
注册一次即可，所以只在第一次注册</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/IndicesRequestCache.java</relativePath>
      </topicLine>
      <topicLine>
        <line>149</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</url>
        <note>调用lucene进行检索且打分</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>342</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</url>
        <note>调用Lucene进行查询，queryCollector收集查询结果并实现排序或自定义结果过滤、整理等</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>152</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</url>
        <note>二阶段排序</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>154</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</url>
        <note>推荐请求部分</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>155</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</url>
        <note>es实现聚合</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>435</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>如果没有hit则释放context，有hit的话后面还要用到这个context</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>441</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>触发executor.close()</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>442</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>如果只查询一个shard，query之后直接执行fetch，省去把id返回给协调节点，协调节点再执行fetch。使用的线程池还是search</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>460</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>开始执行fetch阶段</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>581</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</url>
        <note>query阶段的所有shard返回后，执行next phase</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>104</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/FetchSearchPhase.java</url>
        <note>协调节点执行fetch phase，线程池：search</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/FetchSearchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>115</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/FetchSearchPhase.java</url>
        <note>对querysearchresult的doc进行排序reduce。包含聚合逻辑</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/FetchSearchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>279</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java</url>
        <note>根据shard将doc分组</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java</relativePath>
      </topicLine>
      <topicLine>
        <line>161</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/FetchSearchPhase.java</url>
        <note>遍历每个shard，通过doc ids fetch数据</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/FetchSearchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>172</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/SearchTransportService.java</url>
        <note>将indices:data/read/search[phase/fetch/id] task发送给数据节点</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/SearchTransportService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>574</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>找到query阶段使用的context。相同的context保证查询使用的是相同的reader，即query和fetch查的数据一样</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>582</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>上面都是保存请求信息到context，后面直接传递context作为参数就好</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>584</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>执行fetch phase的excute方法</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>101</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</url>
        <note>用于StoredFields功能</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>105</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</url>
        <note>判断是否需要拉取_source字段</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>156</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</url>
        <note>遍历查询所有的doc id</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>163</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</url>
        <note>计算出这个docId在当前segment上的doc编号。docId是Lucene index粒度唯一的，subDocId是segment粒度唯一的，通过subReaderContext.docBase转换</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>172</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</url>
        <note>调用Lucene读取source</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>194</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</url>
        <note>将doc封装到fetchsearchresult</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>57</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/ActionRunnable.java</url>
        <note>fetch结束后触发listener，传参为fetchSearchResult</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/ActionRunnable.java</relativePath>
      </topicLine>
      <topicLine>
        <line>139</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/FetchSearchPhase.java</url>
        <note>每个shard fetch结束后进行count down并保存fetch search result</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/FetchSearchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>118</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/FetchSearchPhase.java</url>
        <note>所有的shard结束后执行finish phase</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/FetchSearchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>65</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/ExpandSearchPhase.java</url>
        <note>下一个phase是ExpandSearchPhase，实现了折叠字段的功能</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/ExpandSearchPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>537</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</url>
        <note>最后返回search resposne给客户端</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>44</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/rest/action/RestToXContentListener.java</url>
        <note>根据request来build response</note>
        <relativePath>server/src/main/java/org/elasticsearch/rest/action/RestToXContentListener.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>一些类</name>
    <note />
    <updatedAt>2023-05-30 16:57:48</updatedAt>
    <topicLines>
      <topicLine>
        <line>70</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/NodeConnectionsService.java</url>
        <note>当集群状态中节点离开集群，清除对应的connection</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/NodeConnectionsService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>413</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java</url>
        <note>节点加入集群的元数据变更任务</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java</relativePath>
      </topicLine>
      <topicLine>
        <line>79</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java</url>
        <note>负责发送和处理分片状态变为started或者分片失败的类</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>32</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/ClusterStateUpdateTask.java</url>
        <note>更新集群状态的任务抽象类</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/ClusterStateUpdateTask.java</relativePath>
      </topicLine>
      <topicLine>
        <line>50</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/admin/indices/delete/TransportDeleteIndexAction.java</url>
        <note>索引删除</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/admin/indices/delete/TransportDeleteIndexAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>46</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/TransportKeepAlive.java</url>
        <note>调度keep alive ping</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/TransportKeepAlive.java</relativePath>
      </topicLine>
      <topicLine>
        <line>446</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/client/transport/TransportClientNodesService.java</url>
        <note>SniffNodesSampler</note>
        <relativePath>server/src/main/java/org/elasticsearch/client/transport/TransportClientNodesService.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>集群状态更新</name>
    <note>该流程基于Raft算法，保证一致性。
既有共识算法的quorom，term，选举出的主节点特性
也有2PC保证的所有节点应用（未应用节点剔除集群）和publish、commit阶段</note>
    <updatedAt>2023-04-24 11:05:07</updatedAt>
    <topicLines>
      <topicLine>
        <line>246</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterService.java</url>
        <note>其他模块需要更新集群状态时，提交状态更新任务。例如分片分配、节点加入离开集群</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>797</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>提交任务到线程池执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>86</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/TaskBatcher.java</url>
        <note>master的线程池masterService#updateTask执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/TaskBatcher.java</relativePath>
      </topicLine>
      <topicLine>
        <line>187</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/TaskBatcher.java</url>
        <note>updateTask的run方法</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/TaskBatcher.java</relativePath>
      </topicLine>
      <topicLine>
        <line>149</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/TaskBatcher.java</url>
        <note>执行当前任务所有同一个key的task。key为ClusterStateTaskExecutor，需要是同一个实例，因为不同实例的ClusterStateTaskExecutor保存了不同的上下文。</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/TaskBatcher.java</relativePath>
      </topicLine>
      <topicLine>
        <line>201</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>真正开始执行update task</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>218</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>根据当前集群状态和task计算出结果</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>701</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>使用task对应的executor（ClusterStateTaskExecutor）计算结果。这里对于多个task，可能是去重也可能是批量执行，具体看excutor是否实现了批量执行的方法</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>235</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>开始publish cluster state</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1075</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>dicovery层的coordinator进行publish</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>72</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</url>
        <note>向其他节点发送publish请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</relativePath>
      </topicLine>
      <topicLine>
        <line>337</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java</url>
        <note>发送增量cluster state</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>449</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java</url>
        <note>调用传输层发送请求 action:internal:cluster/coordination/publish_state</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>157</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java</url>
        <note>节点处理publish request</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>356</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</url>
        <note>其他节点收到publish request后，/将state保存。persistedState在master-eligible对应LucenePersistedState（同步刷盘），在data对应AsyncLucenePersistedState（异步刷盘）</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>335</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</url>
        <note>处理publish的response</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</relativePath>
      </topicLine>
      <topicLine>
        <line>392</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</url>
        <note>如果确认publish的节点符合Quorum数量，则返回ApplyCommitRequest</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>255</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</url>
        <note>如果确认publish的节点符合Quorum数量，向所有状态合适的节点发送ApplyCommitRequest。否则什么都不做</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</relativePath>
      </topicLine>
      <topicLine>
        <line>353</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java</url>
        <note>调用传输层发送commit request
action:internal:cluster/coordination/commit_state</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>269</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>节点处理applyCommitRequest的方法</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>278</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>master节点在publish过程的最后应用集群状态</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>279</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>节点应用集群状态，调用受影响的applier和listener</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>361</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>非当前master的节点提交集群状态应用任务到优先级的线程池clusterApplierService#updateTask</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>397</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>应用集群状态时执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>476</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>尝试连接下新集群状态中的节点</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>489</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>调用所有的appliers</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>500</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>更改维护的集群状态</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>502</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>调用所有的listener</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>442</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>返回空response给master</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>376</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</url>
        <note>处理applyRequestCommit的返回</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</relativePath>
      </topicLine>
      <topicLine>
        <line>382</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</url>
        <note>master标记localNodeAckEvent为done，其他节点记录下cluster state的版本</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1316</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>如果是本地节点（master），localNodeAckEvent标记为done</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1326</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>如果不是本地节点，更新state记录的版本.该组件负责如果节点超时90s没有应用集群状态，则将它移除集群</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>114</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</url>
        <note>判断taget node是否回复apply commit request或超时。全部结束才会继续</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1389</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>由于之前已经标记localNodeAckEvent为done了（执行完成或者超时），所以listener会直接执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1399</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>master节点触发clusterApplierService ，应用集群状态</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1412</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>触发之后的回调</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1447</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>如果有必要则修改voting configuration</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1450</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>master开始等待90s开启监控，检查哪些数据节点的集群版本低于当前值，若低于的话，直接从被master从集群剔除（applyRequestCommit返回才行）</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>280</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>调用cluster state change task的listener，如果是rest请求触发的，listener将结果返回给coordinator</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1451</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>打印日志，其中包含那些超时30s没有返回的节点</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1356</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>整体publication流程响应超时时间10s的info日志</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1342</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>整体publication流程响应超时时间30s,超时直接结束</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1463</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>如果publish任务失败，master节点退位成candidate，清除所有的publish</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>recovery</name>
    <note>Recovery 其实有两种：
peer:Primary的迁移/Replication的生成和迁移
existing store:Primary的恢复

es源码书  索引恢复流程，其中包含为什么能够保证数据一致性
区别：
peer recovery使用retention lease代替translog来恢复数据</note>
    <updatedAt>2023-03-06 14:08:13</updatedAt>
    <topicLines>
      <topicLine>
        <line>96</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</url>
        <note>应用集群状态时调用该类的接口触发recovery</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>247</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</url>
        <note>根据新的集群状态，创建或更新当前节点上的分片</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>566</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</url>
        <note>如果在当前indexService中找不到新集群状态中的分片，说明需要创建；否则需要更新</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>581</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</url>
        <note>从其他节点恢复（relocate 或者 副本从主分片恢复）</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>592</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</url>
        <note>创建分片并启动recovery</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>766</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/IndicesService.java</url>
        <note>创建分片，包含物理创建分片目录的操作</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/IndicesService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>768</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/IndicesService.java</url>
        <note>启动recovery</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/IndicesService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>2595</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>从本地 store 进行recovery</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>2658</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>标记分片状态为RECOVERING</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>90</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java</url>
        <note>从本地文件系统recover shard</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java</relativePath>
      </topicLine>
      <topicLine>
        <line>411</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java</url>
        <note>保存segments文件名和length到RecoveryState.Index</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java</relativePath>
      </topicLine>
      <topicLine>
        <line>435</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java</url>
        <note>执行translog阶段</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1609</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>从translog恢复</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>482</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>具体从translog恢复的实现</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1604</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>执行translog恢复数据</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1556</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>遍历每条operation进行回放</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>501</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</url>
        <note>flush translog</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java</relativePath>
      </topicLine>
      <topicLine>
        <line>437</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java</url>
        <note>recovery结束阶段，执行refresh，将缓冲数据写入segment，使数据可读</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java</relativePath>
      </topicLine>
      <topicLine>
        <line>2661</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>发送shard started请求给master</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>2598</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</url>
        <note>从其他节点进行recovery(比如集群启动，副本分片recovery)</note>
        <relativePath>server/src/main/java/org/elasticsearch/index/shard/IndexShard.java</relativePath>
      </topicLine>
      <topicLine>
        <line>172</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/PeerRecoveryTargetService.java</url>
        <note>在generic线程池开始副本recovery</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/PeerRecoveryTargetService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>192</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/PeerRecoveryTargetService.java</url>
        <note>进入index阶段</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/PeerRecoveryTargetService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>223</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/PeerRecoveryTargetService.java</url>
        <note>发送recovery请求给primary</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/PeerRecoveryTargetService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>160</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/PeerRecoverySourceService.java</url>
        <note>primary处理replica的recovery请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/PeerRecoverySourceService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>192</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</url>
        <note>获取锁，保证translog不被清理。因为这些新增的translog需要在replica回放</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>195</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</url>
        <note>判断是否可以从SequenceNumber恢复。如果可以则跳过phase1（sendFilePhase）</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>285</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</url>
        <note>执行phase1。Phase1 检查目标节点上的段文件并复制丢失的段。只有具有相同大小和校验和的段才能被重用。有限速配置</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>488</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</url>
        <note>如果sync id和SeqNos相同则跳过phase1</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>502</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</url>
        <note>发送差异文件</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>297</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</url>
        <note>发送给replica请求，让他启动engine准备接收translog,</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>309</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</url>
        <note>通过更改replication group,标记副本分片可以接受写入请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>325</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</url>
        <note>将快照(使用retentionLeases或者translog)发送到replica。其中包含最近的新增索引</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</relativePath>
      </topicLine>
      <topicLine>
        <line>817</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</url>
        <note>将副本加入In sync allocation ids</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>索引创建</name>
    <note />
    <updatedAt>2023-02-27 19:03:54</updatedAt>
    <topicLines>
      <topicLine>
        <line>70</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/admin/indices/create/TransportCreateIndexAction.java</url>
        <note>api请求走到这里</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/admin/indices/create/TransportCreateIndexAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>260</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>创建索引</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>279</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>提交定义创建索引的ClusterStateUpdateTask。Priority.URGENT</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>289</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>master线程池执行索引创建</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>341</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>根据索引名找到template</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>396</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>创建索引</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>398</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>mapping更新</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>409</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>indexMetadata构建</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>821</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>构建新的cluster state</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>826</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>进行单次reroute.返回新的集群状态后，继续集群状态变更流程</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>262</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>创建索引成功后，回调等待分片分配完成并可用</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>268</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</url>
        <note>返回个客户端结果</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>新建索引reroute</name>
    <note />
    <updatedAt>2022-12-19 19:01:07</updatedAt>
    <topicLines>
      <topicLine>
        <line>395</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>新索引创建触发reroute</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>427</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>分配已存在copy的shard，在allocation中讲过</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>428</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>使用BalancedShardsAllocator进行allocate</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>118</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>无可路由节点返回错误</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>122</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>使用allocation相关参数创建balancer</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>123</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>根据权重函数在节点上为分片索引分配所有给定分片。所有给定的分片必须未分配。</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>799</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>根据是否为primary，索引优先级进行排序，shardid（小的优先）
这可确保 Elasticsearch 为尽可能多的索引分配所有主索引，而不是创建多个部分分配的索引。一旦 Elasticsearch 分配了所有主索引，它就会移动到每个索引的第一个副本。
.security7配置了最高的优先级1000</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>804</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>遍历shard进行分配决策</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>886</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>遍历decider进行判断该shard在allocation下是否可以allocate，不可以则直接返回NO。例如maxRetryDecider.
该操作可以提前过滤掉shard</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>912</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>针对每个node计算权重，选择权重最小的节点返回</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>817</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>进行shard的初始化，和allocation模块相同</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>818</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>节点增加shard</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>124</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>给定分片是否可以保留在给定节点，例如exclude ip就需要move了</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>125</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>根据权重算法进行再平衡，shard移动</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>468</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>这建立了一个初始索引排序，最不平衡的索引在最前面。当全局平衡的权重参数超过中间状态的索引平衡时，容易一个索引对添加的节点进行过度分配。所以先对分配最不均衡的索引进行rebalance，这样可以减少中间状态</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>473</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>找到有该索引分片或者可以分配索引分片的节点，并放到数组前面。</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>485</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>少于两个节点咋relocate啊</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>489</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>对relevant节点按权重排序</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>498</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>最大的节点间差值小于阈值则跳出</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>536</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>大于阈值则尝试进行relocate，会使用decider进行决策，可能失败</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>546</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>成功则重新排序，重置idx，继续遍历</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>555</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>失败要么是minnode因decider无法allocate，要么是maxnode无该index的shard，改变idx，直到delta小于阈值</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>556</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</url>
        <note>无法从maxnode relocate任何shard，选择下一个max node，重置mIn node的idx</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>allocation模块</name>
    <note />
    <updatedAt>2022-12-19 18:07:54</updatedAt>
    <topicLines>
      <topicLine>
        <line>261</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/GatewayService.java</url>
        <note>gateway阶段结束后，集群级别和索引级别元数据已确定，
但是shard级别元数据（索引的shard在哪个节点上即routing table）还未确定，通过
调用reroute来allocation shards</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/GatewayService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>392</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>shuffle 未分配的分片。作用是避免一些有问题的分片影响其他分片分配。例如，集群分片分配的并发是1，有一个分片因为文件损坏无法分配，如果不进行shuffle，每次分片分配的都是这个有问题的分片，直到到达次数上限</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>427</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>allocate 已存在的shard copies</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>433</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>使用PriorityComparator对unassigned shard按优先级排序，首先比较index.priority,其次是index create time，最后index name。
没错，鉴权相关的索引优先级最高，确保可以快速向集群发请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>436</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>触发allocators的beforeAllocation</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>440</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>遍历primary shard进行allocate</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>153</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/GatewayAllocator.java</url>
        <note>使用primaryshardallocator allocate primary shard</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/GatewayAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>56</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/BaseGatewayShardAllocator.java</url>
        <note>调用makeAllocationDecision进行决策</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/BaseGatewayShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>79</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</url>
        <note>判断primaryAllocator是否有责任去allocate，无则仍在unassigned list</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>67</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</url>
        <note>必须是primary unassigned 从copy恢复</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>85</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</url>
        <note>从所有节点异步拉取该shard的数据</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>70</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/BaseGatewayShardAllocator.java</url>
        <note>由于fetch data是异步的，当前还无法make decision,忽略当前shard，等拿到数据构建好元数据后，在分配。如果不这样的话，下一步shardsAllocator.allocate将把有shard copy的shard进行分配，这样会导致数据丢失</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/BaseGatewayShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>119</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/AsyncShardFetch.java</url>
        <note>获取fetch data的node列表</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/AsyncShardFetch.java</relativePath>
      </topicLine>
      <topicLine>
        <line>293</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/AsyncShardFetch.java</url>
        <note>向各节点发起异步fetch data请求，action为internal:gateway/local/started_shards</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/AsyncShardFetch.java</relativePath>
      </topicLine>
      <topicLine>
        <line>115</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/TransportNodesListGatewayStartedShards.java</url>
        <note>节点收到fetchdata的请求后执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/TransportNodesListGatewayStartedShards.java</relativePath>
      </topicLine>
      <topicLine>
        <line>119</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/TransportNodesListGatewayStartedShards.java</url>
        <note>从磁盘目录加载shard元数据</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/TransportNodesListGatewayStartedShards.java</relativePath>
      </topicLine>
      <topicLine>
        <line>139</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/TransportNodesListGatewayStartedShards.java</url>
        <note>获取shard路径</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/TransportNodesListGatewayStartedShards.java</relativePath>
      </topicLine>
      <topicLine>
        <line>143</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/TransportNodesListGatewayStartedShards.java</url>
        <note>从shard路径下打开index</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/TransportNodesListGatewayStartedShards.java</relativePath>
      </topicLine>
      <topicLine>
        <line>165</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/TransportNodesListGatewayStartedShards.java</url>
        <note>返回shard查找结果</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/TransportNodesListGatewayStartedShards.java</relativePath>
      </topicLine>
      <topicLine>
        <line>296</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/AsyncShardFetch.java</url>
        <note>所有的fetch response返回触发回调</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/AsyncShardFetch.java</relativePath>
      </topicLine>
      <topicLine>
        <line>199</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/AsyncShardFetch.java</url>
        <note>将shard返回的元数据保存到当前 asyncshardfetch 的cache中，和node对应。asyncshardfetch又对应shard</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/AsyncShardFetch.java</relativePath>
      </topicLine>
      <topicLine>
        <line>230</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/AsyncShardFetch.java</url>
        <note>再次提交一个相同的reroute任务</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/AsyncShardFetch.java</relativePath>
      </topicLine>
      <topicLine>
        <line>95</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/BatchedRerouteService.java</url>
        <note>想clusterservice提交reroute任务</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/BatchedRerouteService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>103</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</url>
        <note>找到所有在in sync allocation id中的节点，并将他们排序</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>284</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</url>
        <note>primaryshardallocator使用NO_STORE_EXCEPTION_FIRST_COMPARATOR和PRIMARY_FIRST_COMPARATOR排序node shard，node shard来自之前的异步拉取</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>126</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</url>
        <note>使用deciders将排序好的节点，切分成三组yes no throttled</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>312</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</url>
        <note>根据是否force reroute选择执行方法。这里是false</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>71</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDeciders.java</url>
        <note>遍历所有的deciders进行决策</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDeciders.java</relativePath>
      </topicLine>
      <topicLine>
        <line>79</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDeciders.java</url>
        <note>只要有一个decider决策为null，则拒绝该节点执行本次分配</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDeciders.java</relativePath>
      </topicLine>
      <topicLine>
        <line>133</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</url>
        <note>选择可分配节点中排序最靠前的节点分配shard</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>141</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</url>
        <note>如果所有的deciders都返回null，尝试强制分配。使用canForceAllocatePrimary决策而不是canAllocate</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/PrimaryShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>63</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/BaseGatewayShardAllocator.java</url>
        <note>根据决策器结果决定是否初始化分片</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/BaseGatewayShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>914</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java</url>
        <note>将shard从unassigned的routing nodes列表中删除</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java</relativePath>
      </topicLine>
      <topicLine>
        <line>429</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java</url>
        <note>初始化一个shardrouting，shardroutingstate为INITIALIZING</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java</relativePath>
      </topicLine>
      <topicLine>
        <line>430</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java</url>
        <note>将shard routing添加到目的节点的shard列表</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java</relativePath>
      </topicLine>
      <topicLine>
        <line>436</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java</url>
        <note>添加到assigned shard列表</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java</relativePath>
      </topicLine>
      <topicLine>
        <line>437</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java</url>
        <note>设置状态已更新</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java</relativePath>
      </topicLine>
      <topicLine>
        <line>455</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>遍历replica shard，进行allocate</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>151</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</url>
        <note>先通过deciders判断一下，是否至少有一个节点可以分配shard，如果分配不了就省略后面逻辑</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>162</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</url>
        <note>拉取分片元数据，注意这里的元数据和primary不同，是NodeStoreFilesMetadata</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>122</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/store/TransportNodesListShardStoreMetadata.java</url>
        <note>响应副本拉取数据的请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/store/TransportNodesListShardStoreMetadata.java</relativePath>
      </topicLine>
      <topicLine>
        <line>388</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</url>
        <note>初始化matching node</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>412</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</url>
        <note>replica shard的allocation node 的比较器.
尽量选择数据最新的节点分配shard。最匹配的节点的排序方式是无需回放操作 retenton lease的seq No较大（意味着需要回放的操作少） 相同的文件大小较大</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>212</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</url>
        <note>最匹配的节点作为决策</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>229</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</url>
        <note>如果没有合适节点，则判断进行延迟分配</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/ReplicaShardAllocator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>236</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>reroute完成后构建集群新的状态。最后master将新的集群状态广播下去</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>130</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>根据allocation结果和old cluster state构建新的cluster state</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>132</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</url>
        <note>打印集群健康状态变化日志</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>247</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</url>
        <note>数据节点收到cluster state change后，应用变化，创建或更新shard</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>620</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</url>
        <note>更新节点上的shard信息</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>569</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</url>
        <note>节点上无该shard时，createshard，进行shard recovery</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>582</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</url>
        <note>寻找用于recovery的source node</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>768</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/indices/IndicesService.java</url>
        <note>创建shard，开始recovery</note>
        <relativePath>server/src/main/java/org/elasticsearch/indices/IndicesService.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>deciders</name>
    <note />
    <updatedAt>2022-08-12 16:21:23</updatedAt>
    <topicLines>
      <topicLine>
        <line>33</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java</url>
        <note>AllocationDecider基类，基于节点进行集群或索引shard级别的allocation决策</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>39</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java</url>
        <note>该shard是否可以rebalance到给定的allocation</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>47</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java</url>
        <note>该shard是否可以allocate到给定的node</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>55</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java</url>
        <note>该shard是否可以在给定的node继续呆着</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>110</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java</url>
        <note>该primary shard是否可以强制allocate到给定节点，
只有在节点上有shard copy未分配primary shard分配时被调用</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>33</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/RebalanceOnlyWhenActiveAllocationDecider.java</url>
        <note>集群必须是绿色才可以rebalance</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/RebalanceOnlyWhenActiveAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>75</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ConcurrentRebalanceAllocationDecider.java</url>
        <note>rebalance的并发shard数限制</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ConcurrentRebalanceAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>53</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ShardsLimitAllocationDecider.java</url>
        <note>控制每个节点上的shard数量，受集群级别和索引级别的配置控制</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ShardsLimitAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>36</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/MaxRetryAllocationDecider.java</url>
        <note>shard在节点上allocate的最大尝试次数</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/MaxRetryAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>34</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ResizeAllocationDecider.java</url>
        <note>确保shrink和split操作将新索引的shard分配到primary shard所在的节点</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ResizeAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>28</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ReplicaAfterPrimaryActiveAllocationDecider.java</url>
        <note>当replica的primary是active状态时，才允许replica分配</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ReplicaAfterPrimaryActiveAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>49</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ClusterRebalanceAllocationDecider.java</url>
        <note>cluster.routing.allocation.allow_rebalance配置的decider，
always:总是可以rebalance
indices_primary_active:所有的primary shard已分配且active（即started状态）才行
indices_all_active:所有的shard已分配且active才行</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ClusterRebalanceAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>60</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/EnableAllocationDecider.java</url>
        <note>allocations / rebalancing的集群粒度配置，根据primary / replica / 等判断是否可以allocate rebalance，索引级别配置会覆盖集群级别配置</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/EnableAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>35</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/NodeVersionAllocationDecider.java</url>
        <note>防止从可能不兼容版本的节点RELOCATE或ALLOCATE</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/NodeVersionAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>66</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/FilterAllocationDecider.java</url>
        <note>exclude include require 节点的decider</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/FilterAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>45</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/SameShardAllocationDecider.java</url>
        <note>避免主副shard分配到同一节点</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/SameShardAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>75</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDecider.java</url>
        <note>磁盘空间使用量的decider
0.85 新shard不会分配
0.9 shard无法待在该节点，会relocate</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>55</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ThrottlingAllocationDecider.java</url>
        <note>限制单个节点上初始主分片恢复操作的数量
限制单个节点上并发恢复shard数量
recovery包含副本从主本同步恢复数据和从本地恢复数据等等详见RecoverySource.Type</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ThrottlingAllocationDecider.java</relativePath>
      </topicLine>
      <topicLine>
        <line>79</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AwarenessAllocationDecider.java</url>
        <note>根据节点配置中定义的 {@code awareness} 键值对控制分片分配。意识根据节点或物理机架位置等属性明确控制应在何处分配副本。感知属性接受任意配置键，如机架数据中心标识符</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AwarenessAllocationDecider.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>node join</name>
    <note />
    <updatedAt>2022-07-15 17:55:47</updatedAt>
    <topicLines>
      <topicLine>
        <line>134</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java</url>
        <note>绑定处理node join请求的handler</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java</relativePath>
      </topicLine>
      <topicLine>
        <line>482</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>尝试和该节点建立链接</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>373</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/transport/TransportService.java</url>
        <note>如果该节点是自己，直接触发response</note>
        <relativePath>server/src/main/java/org/elasticsearch/transport/TransportService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>485</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>如果本节点是master，向该节点发出检验请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>155</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java</url>
        <note>收到校验请求后进行处理，如果不是cluster uuid不同则抛出异常</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java</relativePath>
      </topicLine>
      <topicLine>
        <line>321</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/JoinTaskExecutor.java</url>
        <note>节点的版本校验</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/JoinTaskExecutor.java</relativePath>
      </topicLine>
      <topicLine>
        <line>322</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/JoinTaskExecutor.java</url>
        <note>校验index create时node version和现在节点的version</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/JoinTaskExecutor.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1131</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/Security.java</url>
        <note>校验license</note>
        <relativePath>x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/Security.java</relativePath>
      </topicLine>
      <topicLine>
        <line>526</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>更新term</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>529</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>是否在上次选举中胜出</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>217</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</url>
        <note>处理join</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>258</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</url>
        <note>source node投票给target node</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>260</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</url>
        <note>是否达到quorum</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>549</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</url>
        <note>判断投票节点数是否大于lastCommittedConfiguration的一半</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>266</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</url>
        <note>如果vote胜出，且上次失败</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>535</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>成为leader</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>479</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java</url>
        <note>提交 cluster state更新任务</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java</relativePath>
      </topicLine>
      <topicLine>
        <line>797</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>任务提交给taskBatcher执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>86</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/TaskBatcher.java</url>
        <note>任务放到单线程的优先级队列执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/TaskBatcher.java</relativePath>
      </topicLine>
      <topicLine>
        <line>187</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/TaskBatcher.java</url>
        <note>TaskBatcher的run方法</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/TaskBatcher.java</relativePath>
      </topicLine>
      <topicLine>
        <line>201</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>调用masterService的runtask执行</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>218</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>计算执行完task后的clusterstate</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>249</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>publishing cluster state</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1106</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>publis的封装，包含request target node</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1111</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</url>
        <note>更新leader checker /follower checker / lagdetector的节点</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Coordinator.java</relativePath>
      </topicLine>
      <topicLine>
        <line>72</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</url>
        <note>向target node发送pulish请求</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</relativePath>
      </topicLine>
      <topicLine>
        <line>332</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java</url>
        <note>新加入节点发送全量cluster state，否则发送diff</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>node启动流程</name>
    <note />
    <updatedAt>2022-06-26 09:39:49</updatedAt>
    <topicLines>
      <topicLine>
        <line>74</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/bootstrap/Elasticsearch.java</url>
        <note>bin/elasticsearch命令触发的方法入口</note>
        <relativePath>server/src/main/java/org/elasticsearch/bootstrap/Elasticsearch.java</relativePath>
      </topicLine>
      <topicLine>
        <line>65</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/libs/cli/src/main/java/org/elasticsearch/cli/Command.java</url>
        <note>增加shut down hook,被kill时触发</note>
        <relativePath>libs/cli/src/main/java/org/elasticsearch/cli/Command.java</relativePath>
      </topicLine>
      <topicLine>
        <line>111</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/libs/cli/src/main/java/org/elasticsearch/cli/Command.java</url>
        <note>启动时传入的参数</note>
        <relativePath>libs/cli/src/main/java/org/elasticsearch/cli/Command.java</relativePath>
      </topicLine>
      <topicLine>
        <line>81</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/cli/EnvironmentAwareCommand.java</url>
        <note>解析传入的参数</note>
        <relativePath>server/src/main/java/org/elasticsearch/cli/EnvironmentAwareCommand.java</relativePath>
      </topicLine>
      <topicLine>
        <line>89</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/cli/EnvironmentAwareCommand.java</url>
        <note>根据配置文件和参数创建运行环境实例</note>
        <relativePath>server/src/main/java/org/elasticsearch/cli/EnvironmentAwareCommand.java</relativePath>
      </topicLine>
      <topicLine>
        <line>348</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java</url>
        <note>加载security相关的加密keystore</note>
        <relativePath>server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java</relativePath>
      </topicLine>
      <topicLine>
        <line>385</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java</url>
        <note>检查lucene版本</note>
        <relativePath>server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java</relativePath>
      </topicLine>
      <topicLine>
        <line>392</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java</url>
        <note>// 1.进行初始化设置
// 2.加载modules并配置守护线程
// 3.本地环境检查
// 4.增加shutdown hook 关闭node以及spawner下的modules 关闭日志
// 5.初始化node和NodeEnvironment 
// 6.初始化plugins
// 7.创建Node对象</note>
        <relativePath>server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java</relativePath>
      </topicLine>
      <topicLine>
        <line>136</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/plugins/PluginsService.java</url>
        <note>从目录下加载modules</note>
        <relativePath>server/src/main/java/org/elasticsearch/plugins/PluginsService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>152</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/plugins/PluginsService.java</url>
        <note>从目录下加载plugings</note>
        <relativePath>server/src/main/java/org/elasticsearch/plugins/PluginsService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>243</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/plugins/PluginsService.java</url>
        <note>加载module目录下的pluing，配置到Guice的injector中</note>
        <relativePath>server/src/main/java/org/elasticsearch/plugins/PluginsService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>401</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java</url>
        <note>node启动</note>
        <relativePath>server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java</relativePath>
      </topicLine>
      <topicLine>
        <line>758</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/node/Node.java</url>
        <note>从injector中获取注入的实例并启动</note>
        <relativePath>server/src/main/java/org/elasticsearch/node/Node.java</relativePath>
      </topicLine>
      <topicLine>
        <line>137</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/GatewayMetaState.java</url>
        <note>从磁盘加载cluster state</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/GatewayMetaState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>135</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/GatewayService.java</url>
        <note>向cluster state注册listener</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/GatewayService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>148</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/GatewayService.java</url>
        <note>gateway 开始恢复元数据</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/GatewayService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>256</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/gateway/GatewayService.java</url>
        <note>根据cluster state 构建routing table</note>
        <relativePath>server/src/main/java/org/elasticsearch/gateway/GatewayService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>72</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</url>
        <note>向所有节点publish cluster state</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/coordination/Publication.java</relativePath>
      </topicLine>
      <topicLine>
        <line>90</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/discovery/zen/ElectMasterService.java</url>
        <note>根据cluster state的版本确定节点的选主顺序</note>
        <relativePath>server/src/main/java/org/elasticsearch/discovery/zen/ElectMasterService.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>scroll search</name>
    <note />
    <updatedAt>2022-05-06 12:21:52</updatedAt>
    <topicLines>
      <topicLine>
        <line>198</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/SearchScrollAsyncAction.java</url>
        <note>将请求转发到data节点</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/SearchScrollAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>478</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>通过context id找到context，其中包含查询的一切信息</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1066</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>记录scroll search到的位置from+size</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>1067</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>重置scroll 的alive time</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>195</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</url>
        <note>跳过之前查询过的doc</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/query/QueryPhase.java</relativePath>
      </topicLine>
      <topicLine>
        <line>580</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>从request获取lastEmittedDoc，lastEmittedDoc标识fetch从哪里开始</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>68</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/TransportSearchHelper.java</url>
        <note>将scroll id转换成node-&gt;context id</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/TransportSearchHelper.java</relativePath>
      </topicLine>
      <topicLine>
        <line>88</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/search/SearchScrollQueryThenFetchAsyncAction.java</url>
        <note>通过ShardFetchRequest告知data节点上searchContext本次的lastEmittedDoc
，并更新在context中供下次查询使用</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/SearchScrollQueryThenFetchAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>187</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/action/search/SearchScrollAsyncAction.java</url>
        <note>query结束后，开始fetch phase</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/search/SearchScrollAsyncAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>502</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/elasticsearch/server/src/main/java/org/elasticsearch/search/SearchService.java</url>
        <note>如果是返回结果给当前节点，即查询的数据节点就是协调节点，直接使用当前线程池（search）触发listener</note>
        <relativePath>server/src/main/java/org/elasticsearch/search/SearchService.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>cat threadpool</name>
    <note />
    <updatedAt>2022-04-25 19:32:42</updatedAt>
    <topicLines>
      <topicLine>
        <line>78</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/rest/action/cat/RestTable.java</url>
        <note>根据request param build response</note>
        <relativePath>server/src/main/java/org/elasticsearch/rest/action/cat/RestTable.java</relativePath>
      </topicLine>
      <topicLine>
        <line>68</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/action/admin/cluster/node/stats/TransportNodesStatsAction.java</url>
        <note>执行nodestats request</note>
        <relativePath>server/src/main/java/org/elasticsearch/action/admin/cluster/node/stats/TransportNodesStatsAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>276</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java</url>
        <note>构建thread pool stats</note>
        <relativePath>server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java</relativePath>
      </topicLine>
      <topicLine>
        <line>76</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/rest/action/cat/RestThreadPoolAction.java</url>
        <note>处理cat thread pool 的rest request</note>
        <relativePath>server/src/main/java/org/elasticsearch/rest/action/cat/RestThreadPoolAction.java</relativePath>
      </topicLine>
      <topicLine>
        <line>792</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/client/support/AbstractClient.java</url>
        <note>调用nodesstats方法，方法中包含了执行的action</note>
        <relativePath>server/src/main/java/org/elasticsearch/client/support/AbstractClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>113</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/client/node/NodeClient.java</url>
        <note>从所有的action中获取action对应的transportaction子类</note>
        <relativePath>server/src/main/java/org/elasticsearch/client/node/NodeClient.java</relativePath>
      </topicLine>
      <topicLine>
        <line>276</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java</url>
        <note>构建当前状态下的threadpool stats</note>
        <relativePath>server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
  <topic>
    <name>cluster state</name>
    <note>集群状态clusterstate中封装的一些信息</note>
    <updatedAt>2022-04-17 09:57:58</updatedAt>
    <topicLines>
      <topicLine>
        <line>177</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/ClusterState.java</url>
        <note>包含节点到shard的映射关系，unassigned shard的信息</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/ClusterState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>164</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/ClusterState.java</url>
        <note>元数据，包含集群setting，template（模板），所有index元数据。index信息包含index的mapping、alias；所有index的open or close</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/ClusterState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>160</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/ClusterState.java</url>
        <note>索引及对应的路由信息，包含所有index和对应的shard信息</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/ClusterState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>166</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/ClusterState.java</url>
        <note>表示当前集群级别的block信息，以阻止对集群执行的脏操作。</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/ClusterState.java</relativePath>
      </topicLine>
      <topicLine>
        <line>391</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/node/Node.java</url>
        <note>每个节点都启动clusterservice，其中包含clusterstateapplier</note>
        <relativePath>server/src/main/java/org/elasticsearch/node/Node.java</relativePath>
      </topicLine>
      <topicLine>
        <line>397</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>定时更新集群状态</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>518</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>当集群状态变化时，遍历所有applier进行处理</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>502</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>当集群状态处理完后，通知每个listener</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>119</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</url>
        <note>运行集群任务的线程池</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/MasterService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>147</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</url>
        <note>应用集群任务的线程池</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java</relativePath>
      </topicLine>
      <topicLine>
        <line>30</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/ClusterStateUpdateTask.java</url>
        <note>提交的具体任务之一，任务会更新集群状态</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/ClusterStateUpdateTask.java</relativePath>
      </topicLine>
      <topicLine>
        <line>246</line>
        <inProject>true</inProject>
        <url>file:///Users/panning/IdeaProjects/es7.9.1/elasticsearch/server/src/main/java/org/elasticsearch/cluster/service/ClusterService.java</url>
        <note>向集群提交任务</note>
        <relativePath>server/src/main/java/org/elasticsearch/cluster/service/ClusterService.java</relativePath>
      </topicLine>
    </topicLines>
  </topic>
</topics>

